---
import { getCollection } from "astro:content";
import { getGitHubCollections, type GitHubContentData } from "@lib/github-loader";

type Entry = {
  id: string;
  data: GitHubContentData;
};

// Get all collection names
const GITHUB_OWNER = "iammatthias";
const GITHUB_REPO = "obsidian_cms";
const GITHUB_TOKEN = import.meta.env.GITHUB;

const collectionNames = await getGitHubCollections(GITHUB_OWNER, GITHUB_REPO, GITHUB_TOKEN, "main", "content");

// Get recent entries from each collection
// Note: Entries are already filtered by published status and sorted by recency at the loader level
const recentByCollection = await Promise.all(
  collectionNames.map(async (name) => {
    try {
      const entries = (await getCollection(name as any)) as Entry[];
      return {
        name,
        recent: entries.slice(0, 3),
      };
    } catch (error) {
      console.error(`Error loading collection ${name}:`, error);
      return {
        name,
        recent: [] as Entry[],
      };
    }
  })
);

// Filter out collections with no recent content
const collectionsWithContent = recentByCollection
  .filter((c) => c.recent.length > 0)
  .sort((a, b) => {
    const dateA = new Date(a.recent[0].data.created).getTime();
    const dateB = new Date(b.recent[0].data.created).getTime();
    return dateB - dateA; // Most recent first
  });
---

<section>
  <div class='grid'>
    {
      collectionsWithContent.map((collection) => (
        <div class='collection-section'>
          <h3>
            <a href={`/content/${collection.name}`}>{collection.name}</a>
          </h3>
          <ul>
            {collection.recent.map((entry) => (
              <li>
                <a href={`/content/${collection.name}/${entry.id}`}>{entry.data.title}</a>
                <br />
                <span class='date'>{new Date(entry.data.created).toLocaleDateString()}</span>
              </li>
            ))}
            <li>
              <a href={`/content/${collection.name}`}>View all →</a>
            </li>
          </ul>
        </div>
      ))
    }
  </div>
  {
    collectionsWithContent.length > 0 && (
      <div class='view-all'>
        <a href='/content'>View all content →</a>
      </div>
    )
  }
</section>

<style>
  section {
    margin-top: auto;
    min-height: calc(50vh - 2rem);
    border-top: 1px solid var(--color-border);
    padding: 2rem;
    @media (max-width: 768px) {
      padding: 1rem;
    }
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 2rem;
  }

  .collection-section {
    border: 1px solid var(--color-border);
    padding: 1.5rem;
    @media (max-width: 768px) {
      padding: 1rem;
    }
  }

  .collection-section h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.5rem;
  }

  .collection-section h3 a {
    text-decoration: none;
    color: inherit;
    text-transform: capitalize;
  }

  .collection-section h3 a:hover {
    text-decoration: underline;
  }

  .collection-section ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .collection-section ul li {
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--color-border);
  }

  .collection-section ul li:last-child {
    border-bottom: none;
  }

  .collection-section ul li a {
    text-decoration: none;
    color: inherit;
  }

  .collection-section ul li a:hover {
    text-decoration: underline;
  }

  .view-all {
    text-align: center;
  }

  .view-all a {
    text-decoration: none;
    color: inherit;
    font-weight: 500;
  }

  .view-all a:hover {
    text-decoration: underline;
  }

  .date {
    color: var(--color-muted);
    font-size: 0.85rem;
  }
</style>
