---
import { Head } from "astro-capo";
// @ts-ignore
import { SEO } from "astro-seo";
import PostHog from "@components/posthog.astro";
import { ClientRouter } from "astro:transitions";
// styles
import "@/styles/reset.css";
import "@/styles/global.css";
import "@/styles/typography.css";

// components
import Footer from "@components/Footer.astro";
import Nav from "@components/Nav.astro";
import Sidebar from "@components/Sidebar.astro";
const { title, path } = Astro.props;

let seoTitle = "@iammatthias";
if (title || path) {
  seoTitle = "";
  if (title) {
    seoTitle += `${title} | `;
  }
  if (path) {
    seoTitle += `${path.charAt(0).toUpperCase() + path.slice(1)} | `;
  }
  seoTitle += "@iammatthias";
}

const base_url = Astro.url.origin;

let seoImage = `${base_url}/api/og.png`;

if (title || path) {
  if (path) {
    seoImage = `${base_url}/api/og-${path}.png`;
  }
  if (title && path) {
    seoImage = `${base_url}/api/og-${path}-${encodeURIComponent(title)}.png`;
  }
}
---

<html lang='en' transition:animate='none'>
  <Head>
    <ClientRouter fallback='animate' />
    <SEO
      charset='UTF-8'
      title={seoTitle}
      description='A digital garden where photographs, recipes, and thoughts can grow.'
      openGraph={{
        basic: {
          title: seoTitle,
          type: "website",
          image: seoImage,
        },
        optional: {
          description: "A digital garden where photographs, recipes, and thoughts can grow.",
        },
      }}
      twitter={{
        creator: "@iammatthias",
        card: "summary_large_image",
        image: seoImage,
        title: seoTitle,
        description: "A digital garden where photographs, recipes, and thoughts can grow.",
      }}
      extend={{
        link: [
          {
            rel: "icon",
            href: "data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Ctext%20y%3D%22.9em%22%20font-size%3D%2290%22%3E%F0%9F%8C%9E%3C%2Ftext%3E%3C%2Fsvg%3E",
          },
          {
            rel: "sitemap",
            type: "application/xml",
            href: "/sitemap-index.xml",
          },
        ],
        meta: [
          {
            name: "viewport",
            content: "width=device-width, initial-scale=1",
          },
          {
            name: "generator",
            content: "Astro",
          },
        ],
      }}
    />
    <PostHog />
  </Head>
  <body>
    <Nav transition:persist />
    <Sidebar transition:persist />
    <main transition:animate='fade'>
      <slot />
    </main>
    <Footer transition:persist />
  </body>
</html>

<style>
  :root {
    --nav-height: 45px;
    --footer-height: 45px;
    --aside-width: 45px;
  }

  body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  main {
    margin: 0 0 0 var(--aside-width);
    display: flex;
    flex-direction: column;
    width: calc(100% - var(--aside-width));
    gap: 1px;
    min-height: calc(100vh - var(--nav-height) - var(--footer-height) - 4px);
    position: relative;
    contain: layout style paint;
    will-change: opacity;
  }

  /* View transition styles */
  ::view-transition-old(root),
  ::view-transition-new(root) {
    animation: none;
    mix-blend-mode: normal;
  }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    ::view-transition-old(root),
    ::view-transition-new(root) {
      mix-blend-mode: normal;
    }
  }

  /* Fade transition */
  ::view-transition-old(main),
  ::view-transition-new(main) {
    animation: none;
    mix-blend-mode: normal;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes fadeOut {
    from {
      opacity: 1;
    }
    to {
      opacity: 0;
    }
  }

  ::view-transition-old(main) {
    animation: fadeOut 0.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  ::view-transition-new(main) {
    animation: fadeIn 0.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  /* Ensure content is properly contained during transitions */
  ::view-transition-old(main) *,
  ::view-transition-new(main) * {
    contain: layout style paint;
  }

  /* Respect reduced motion preferences */
  @media (prefers-reduced-motion: reduce) {
    ::view-transition-old(main),
    ::view-transition-new(main) {
      animation: none;
    }
  }

  /* Prevent transition conflicts with nav/sidebar */
  nav,
  aside {
    z-index: 100;
    position: relative;
    contain: layout style paint;
  }
</style>

<script is:inline type='module' src='https://cdn.jsdelivr.net/npm/lite-vimeo-embed/+esm'></script>

<script>
  // Format time without seconds and update every minute
  const time = document.querySelector("time");
  function updateTime() {
    const now = new Date();
    const formattedTime = now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    time!.textContent = formattedTime;
    time!.setAttribute("datetime", now.toISOString());
  }

  updateTime();
  setInterval(updateTime, 60000);
</script>
